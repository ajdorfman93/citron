<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Modal Fix Demo</title>
  <!-- minimal styling for demonstration -->
  <style>
    /* basic layout so you can see items */
    .folio-list {
      list-style: none;
      padding: 0;
      margin: 1rem 0;
      display: flex;
      gap: 1rem;
    }
    .folio-list__item {
      border: 1px solid #ccc;
      padding: 1rem;
      flex: 1 1 auto;
      position: relative;
    }
    .folio-list__item-pic img {
      width: 100%;
      height: auto;
      display: block;
    }
    .folio-list__item-cat { font-weight: bold; }
    .folio-list__proj-link {
      position: absolute; 
      top: 0.5rem; 
      right: 0.5rem;
    }
    /* minimal style to see that basicLightbox is working */
    .basicLightbox--visible .modal-popup {
      /* just to see the white box on top */
      background: #fff;
      border: 1px solid #999;
      padding: 2rem;
      max-width: 600px;
      margin: 50px auto;
    }
  </style>

  <!-- BasicLightbox CSS (optional, but recommended) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/basiclightbox/dist/basicLightbox.min.css">
</head>
<body>

<h1>Modal Fix Demo</h1>

<ul class="folio-list" id="portfolioList"></ul>

<!-- Container for dynamic modals -->
<div id="modalContainer"></div>

<!-- 1) BasicLightbox library -->
<script src="https://cdn.jsdelivr.net/npm/basiclightbox@5.0.4/dist/basicLightbox.min.js"></script>

<script>
// --------------------------------------------------------------------
// Example "records" from your portfolioData.json
// (Simulating fetch for clarity. You can remove the setTimeout in real use.)
// --------------------------------------------------------------------
// portfolio.js

fetch('js/portfolioData.json') // Adjust if your JSON file is at a different URL/path
  .then(response => response.json())
  .then(data => {
    // data.records is the array we need.
    const records = data.records;
    createPortfolioItems(records);
    createModals(records);
  })
  .catch(error => {
    console.error('Error fetching portfolio data:', error);
  });

// --------------------------------------------------------------------
// 2) createPortfolioItems() + createModals() (same as in your code)
// --------------------------------------------------------------------
function createPortfolioItems(records) {
  const portfolioList = document.getElementById('portfolioList');

  records.forEach(record => {
    const fields = record.fields;
    // <li>
    const li = document.createElement('li');
    li.className = 'folio-list__item column';

    // main link
    const itemLink = document.createElement('a');
    itemLink.className = 'folio-list__item-link';
    itemLink.href = `#${fields.modalId}`; // e.g. "#modal-01"

    // image
    const itemPic = document.createElement('div');
    itemPic.className = 'folio-list__item-pic';
    const img = document.createElement('img');
    img.src = fields.thumbnailImage;
    img.alt = fields.altText || '';
    itemPic.appendChild(img);

    // text
    const itemText = document.createElement('div');
    itemText.className = 'folio-list__item-text';
    
    const catDiv = document.createElement('div');
    catDiv.className = 'folio-list__item-cat';
    catDiv.textContent = fields.category;
    
    const titleDiv = document.createElement('div');
    titleDiv.className = 'folio-list__item-title';
    titleDiv.textContent = fields.projectTitle;

    itemText.appendChild(catDiv);
    itemText.appendChild(titleDiv);

    itemLink.appendChild(itemPic);
    itemLink.appendChild(itemText);

    // external project link
    const projLink = document.createElement('a');
    projLink.className = 'folio-list__proj-link';
    projLink.href = fields.projectLink;
    projLink.title = 'project link';
    projLink.innerHTML = `
      <svg width="15" height="15" viewBox="0 0 15 15" fill="none"
        xmlns="http://www.w3.org/2000/svg">
        <path d="M8.14645 3.14645C8.34171 2.95118 8.65829 2.95118 8.85355 3.14645
                 L12.8536 7.14645C13.0488 7.34171 13.0488 7.65829 12.8536 7.85355
                 L8.85355 11.8536C8.65829 12.0488 8.34171 12.0488 8.14645 11.8536
                 C7.95118 11.6583 7.95118 11.3417 8.14645 11.1464
                 L11.2929 8H2.5C2.22386 8 2 7.77614 2 7.5
                 C2 7.22386 2.22386 7 2.5 7H11.2929L8.14645 3.85355
                 C7.95118 3.65829 7.95118 3.34171 8.14645 3.14645Z"
              fill="currentColor" fill-rule="evenodd" clip-rule="evenodd"></path>
      </svg>
    `;

    li.appendChild(itemLink);
    li.appendChild(projLink);
    portfolioList.appendChild(li);
  });
}

function createModals(records) {
  const modalContainer = document.getElementById('modalContainer');

  records.forEach(record => {
    const fields = record.fields;
    let cleanedCategories = [];
    if (Array.isArray(fields.modalCategories)) {
      cleanedCategories = fields.modalCategories.filter(cat => cat !== 'L');
    }

    // outer <div>
    const modalDiv = document.createElement('div');
    modalDiv.id = fields.modalId; 
    // By default "hidden" attribute can confuse basicLightbox. Let's omit it:
    // modalDiv.hidden = true;

    // for basicLightbox, you typically need an element with some styling or classes
    const modalPopup = document.createElement('div');
    modalPopup.className = 'modal-popup';
    // you can still style .modal-popup in your CSS

    // image
    const modalImg = document.createElement('img');
    modalImg.src = fields.modalImage;
    modalImg.alt = fields.altText || '';

    // text
    const descDiv = document.createElement('div');
    descDiv.className = 'modal-popup__desc';

    const h5 = document.createElement('h5');
    h5.textContent = fields.modalTitle;

    const p = document.createElement('p');
    p.textContent = fields.modalDescription;

    const ul = document.createElement('ul');
    ul.className = 'modal-popup__cat';
    cleanedCategories.forEach(cat => {
      const li = document.createElement('li');
      li.textContent = cat;
      ul.appendChild(li);
    });

    // project link
    const projectLink = document.createElement('a');
    projectLink.href = fields.projectLink;
    projectLink.className = 'modal-popup__details';
    projectLink.textContent = fields.modalTitle;

    // build 
    descDiv.appendChild(h5);
    descDiv.appendChild(p);
    descDiv.appendChild(ul);

    modalPopup.appendChild(modalImg);
    modalPopup.appendChild(descDiv);
    modalPopup.appendChild(projectLink);

    modalDiv.appendChild(modalPopup);
    modalContainer.appendChild(modalDiv);
  });
}

// --------------------------------------------------------------------
// 3) The function that sets up basicLightbox triggers (ssLightbox)
//    Must be called AFTER we create the .folio-list__item-link and #modal-xx elements
// --------------------------------------------------------------------
function ssLightbox() {
  const folioLinks = document.querySelectorAll('.folio-list__item-link');
  const modals = [];

  folioLinks.forEach(link => {
    let modalbox = link.getAttribute('href'); // e.g. "#modal-01"
    // e.g. document.querySelector('#modal-01')
    let element = document.querySelector(modalbox);
    
    // Pass that element into basicLightbox.create
    let instance = basicLightbox.create(element, {
      onShow: function(instance) {
        // close if user hits ESC
        document.addEventListener("keydown", function escHandler(evt) {
          if (evt.key === "Escape") instance.close();
        });
      }
    });
    modals.push(instance);
  });

  // attach click to each link
  folioLinks.forEach((link, i) => {
    link.addEventListener("click", function(event) {
      event.preventDefault();
      if (modals[i]) {
        modals[i].show();
      }
    });
  });
}

// --------------------------------------------------------------------
// 4) Simulate an async fetch, then create items, then run ssLightbox
// --------------------------------------------------------------------
setTimeout(() => {
  // in real code:
  // fetch('js/portfolioData.json')
  //   .then(r => r.json())
  //   .then(data => {
  //     const records = data.records;
  //     createPortfolioItems(records);
  //     createModals(records);
  //     ssLightbox(); 
  //   });

  const records = mockData.records;
  createPortfolioItems(records);
  createModals(records);
  ssLightbox();

}, 500);

</script>

</body>
</html>
